#!/usr/bin/env bash

pushd `pwd` # store current dir
cd `dirname "$0"` # cd to script path

echo "--- checking environment..."

export NODE_ENV=development

if [ -z $DATABASE_URL ];then
  # for local tests
  export DATABASE_URL="postgres://localhost:5432/signal_boost_test"
fi

source .env

kill-app(){
  # kill ngrok processes
  pid=`ps aux | grep ngrok | sed -n 1p | awk '{print $2}'`
  kill $pid

  pid=`ps aux | grep ngrok | sed -n 1p | awk '{print $2}'`
  kill $pid

  # kill app server
  pid=`ps aux | lsof -i:3000 | sed -n 2p | awk '{print $2}'`
  kill $pid
}

echo "--- shutting down running app instances"
kill-app

echo "----- starting app..."
cd ../../
nf start &

echo "----- running e2e tests..."
cd test/e2e
find . -name '*.spec.js' | xargs npx mocha -R spec -r babel-register --exit

echo "----- shutting down app..."
kill-app

popd # return to original dir
